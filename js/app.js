"use strict";!function(t){function e(){return t.Database}function n(t,e){return Array.isArray(t)?t.indexOf(e)<0?t.concat(e):t.slice():[e]}function r(t,e){return Math.max.apply(0,t.map(function(t){return t[e]||0}))}function a(t){return n(t,i())}function i(){return t.Time.getTodayString()}function o(t,e){return t.find(function(t){return t.id===e})||{id:e}}function s(t,e){return b(t).then(function(n){return p({id:t,tableNumber:e,seatedDays:a(n.seatedDays),seatedLast:moment().format(),standbyOrder:null,lotteryOrder:null})})}function l(t){return m().then(function(e){return p({id:t,standbyOrder:r(e,"standbyOrder")+1,lotteryOrder:null,tableNumber:null,roomNumber:null,standbyDays:a(o(e,t).standbyDays)})})}function d(t,e){return p({id:t,tableNumber:null,lotteryOrder:null,standbyOrder:null,lotteryEligible:e,roomNumber:null})}function u(t){return m().then(function(e){return p({id:t,lotteryOrder:r(e,"lotteryOrder")+1,standbyOrder:null,tableNumber:null,roomNumber:null})})}function c(){return e().open().artists.clear().then(y)}function f(t){return e().open().artists["delete"](+t).then(y)}function m(){return e().open().artists.toArray()}function b(t){return e().open().artists.get(+t)}function h(t){var n=e();return n.transaction(function(){t.forEach(function(t){var e=!t.id,r=Object.assign({},t);delete r.id,e?n.open().artists.put(r):n.open().artists.update(+t.id,r)}),y()})}function p(t){return h([t])}function y(){return e().incrementTableVersion($)}t.Artists={addLottery:u,appendToday:a,clear:c,"delete":f,get:b,getAll:m,set:p,setAll:h,setSeated:s,setStandby:l,setSignedOut:d};var $="artists"}("undefined"!=typeof window?window:exports),function(t){function e(){if(!c){var t=new Dexie(b);t.version(1).stores({artists:["++id","name","badgeNumber","tableNumber","roomNumber","phone","remarks","lotteryEligible","lotteryGuaranteed","lotteryOrder","seatedLast","seatedDays","standbyDays","standbyOrder"].join(),tableVersions:["++id","artists"].join()}),t.open()["catch"](r),Dexie.Promise.on("error",r),c=t}return c}function n(t){return e()[t].schema}function r(t){var e=new Error,n="Dexie has encountered an error: "+t+"\n\n"+e.stack;console.error(n)}function a(){var t=e();return c=null,t["delete"]()}function i(t){var n=e();return m?t():n.transaction("rw",n.tables.map(function(t){return t.name}),function(){m=!0;var e=t();return m=!1,e})}function o(){return e().tableVersions.get(1)}function s(t){return o(t).then(function(n){return n||(n={id:1}),n[t]||(n[t]=0),n[t]++,e().tableVersions.put(n)})}function l(){var t={},n=e().tables;return Promise.all(n.map(function(e){return new Promise(function(n){return e.name.toLowerCase()===f?void n():void e.toArray(function(r){var a=[];r.forEach(function(t){a.push(t)}),t[e.name]=a,n()})})})).then(function(){return Promise.resolve(t)})}function d(t){return Promise.all(Object.keys(t).map(function(n){if(n.toLowerCase()!==f){var r=e()[n];console.log("clear table "+n);var a=r.clear?r.clear():Promise.resolve();return a.then(function(){var e=t[n];return Promise.all(e.map(function(t){return r.put(t)})),s(n)})}}))}function u(t){b=t,c&&(c.close(),c=null)}var c;t.Database={backup:l,"delete":a,getSchema:n,getTableVersion:o,incrementTableVersion:s,open:e,restore:d,select:u,transaction:i};var f="tableversions",m=!1,b="ArtTrackPlus2"}("undefined"!=typeof window?window:exports),function(t){function e(t){return $("<i/>").addClass("fa fa-"+t)}function n(t){return $("<span/>").addClass(t)}function r(t){var r=n("artist-symbols"),a=!t.seatedLast&&t.standbyDays&&t.standbyDays.length>=2;return t.lotteryOrder>0&&r.append(e("check").attr("title","Picked For Lottery")),t.standbyOrder>0&&r.append(e("clock-o").attr("title","On Standby")),t.tableNumber&&r.append(e("sign-in").attr("title","Signed In")),a&&r.append(e("exclamation attention").attr("title","This artist has been on standby for at least two days.")),r}t.Elements={buildIcon:e,buildSpan:n,buildSymbols:r}}(window),function(t,e){function n(n,r){return new Promise(function(a){var i=e.createElement("a");i.href=t.URL.createObjectURL(new Blob([r],{type:"text/csv"})),i.download=n,e.body.appendChild(i),i.click(),e.body.removeChild(i),a()})}function r(t){return new Promise(function(e,n){var r=new FileReader;r.onload=function(t){e(t.target.result)},r.onerror=function(t){n(t)},r.readAsText(t)})}t.FileTransfer={download:n,upload:r}}(window,document),function(t){function e(e){var n=t.Time.getTodayString();return e.filter(function(t){return!!t.seatedDays&&!t.tableNumber&&t.seatedDays.indexOf(n)>=0})}function n(t){return b(c(t,"lotteryOrder"))}function r(t){return c(t,"lotteryEligible")}function a(t){return c(t,"lotteryGuaranteed")}function i(t){return u(t,"lotteryOrder")}function o(t){return b(c(t,"tableNumber"))}function s(t){return m(c(t,"tableNumber"),"tableNumber")}function l(t){return b(c(t,"standbyOrder"))}function d(t){return u(t,"standbyOrder")}function u(t,e,n){return f(c(t,e),n||e)}function c(t,e){return t.filter(function(t){return!!t[e]})}function f(t,e){return t.slice().sort(function(t,n){var r=t[e],a=n[e];return r>a?1:r<a?-1:0})}function m(t,e){return t.slice().sort(function(t,n){var r=+t[e],a=+n[e];return r>a?1:r<a?-1:0})}function b(t){return t.slice().sort(function(t,e){var n=(t.name||"").toLocaleLowerCase(),r=(e.name||"").toLocaleLowerCase();return n>r?1:n<r?-1:0})}t.Filter={checkedOutToday:e,lottery:n,lotteryEligible:r,lotteryGuaranteed:a,lotteryInOrder:i,seated:o,seatedInOrder:s,sorted:b,standby:l,standbyInOrder:d}}("undefined"!=typeof window?window:exports),function(t){function e(){var t={name:"Test "+(n(9e3)+1e3),badgeNumber:n(1e4)+1,phone:r([null,i()]),remarks:r([null,"Etc Whatever"]),lotteryEligible:a()};return t}function n(t){return Math.floor(Math.random()*t)}function r(t){return t[n(t.length)]}function a(){return Math.random()>=.5}function i(){var t=r([".","-",""]),e=r(["","1"+t]);return e+(n(800)+200)+t+(n(800)+200)+t+(n(9e3)+1e3)}t.Generator={getRandomArtist:e}}("undefined"!=typeof window?window:exports),function(t){function e(t){t.forEach(function(t){t.lotteryOrder=null,t.standbyOrder=null,t.tableNumber=null})}function n(t){var e=t.length;t.forEach(function(n,r){var a=Math.floor(Math.random()*e),i=t[r];t[r]=t[a],t[a]=i})}function r(t){Artists.getAll().then(function(r){var a=Filter.lotteryEligible(r);e(r),n(a);var i=1;a.forEach(function(e){t>0&&e.lotteryGuaranteed&&(e.lotteryOrder=i++,t--)});var o=1;a.forEach(function(e){e.lotteryOrder||(t>0?(e.lotteryOrder=i++,t--):(e.standbyOrder=o++,e.standbyDays=Artists.appendToday(e.standbyDays)))}),Artists.setAll(a)})}t.Lottery={reset:e,run:r}}("undefined"!=typeof window?window:exports),function(t){function e(t){A.push(t)}function n(t){A.length>0&&A.pop()(t)}function r(){A.length>0&&A.pop()($("#prompt-dialog input").val())}function a(t){$("#artist-detail .artist-symbols").html(Elements.buildSymbols(t)),$("#artist-id").text(t.id||"0"),$("#artist-name").val(t.name||""),$("#artist-badge").val(t.badgeNumber||""),$("#artist-table").val(t.tableNumber||""),$("#artist-room").val(t.roomNumber||""),$("#artist-phone").val(t.phone||""),$("#artist-remarks").val(t.remarks||""),$("#artist-lottery-eligible").prop("checked",t.lotteryEligible||!1),$("#artist-lottery-guaranteed").prop("checked",t.lotteryGuaranteed||!1),$("#artist-seated-last").text(t.seatedLast?moment(t.seatedLast).calendar():"Never"),$("#artist-seated-days").text(t.seatedDays||"Never"),$("#artist-standby-days").text(t.standbyDays||"Never")}function i(t){t=!!t,$("#artist-table").prop("disabled",t),$("#artist-room").prop("disabled",t),t?($(".artist-add-only").show(),$(".artist-edit-only").hide()):($(".artist-add-only").hide(),$(".artist-edit-only").show())}function o(t,e){k=!!t,a({lotteryEligible:!0}),i(!0),$("#artist-detail-mode").text("New Artist "),e||$("#artist-detail").modal()}function s(){$("#batch-sign-out").modal()}function l(){Artists.getAll().then(function(e){var n=$("<div/>");e=Filter.seatedInOrder(e),e.forEach(function(t){var e=$("<p/>").addClass("form-control-static").text(t.name),r=$("<p/>").addClass("form-control-static").text(t.tableNumber),a=$("<input/>").addClass("form-control").attr("type","text").attr("id","bulk-artist-room-number-"+t.id).attr("value",t.roomNumber).attr("data-artist-id",t.id);n.append($("<tr/>").append($("<td/>").append(e)).append($("<td/>").append(r)).append($("<td/>").append(a)))}),$("#bulk-artist-room-table").html(n.html()),$("#bulk-artist-room-table input[type=text]").last().keydown(function(e){13===e.which&&(e.preventDefault(),t.setTimeout(function(){$("[data-save=rooms]").focus()},10))}),$("#bulk-artist-room").modal(),$("#bulk-artist-room .room-content").each(function(){var t=$(this);t.hasClass("scroll-added")||(t.addClass("scroll-added"),t.slimScroll({height:"100%"}))})})}function d(t){Artists.get(t).then(function(t){a(t),$("#artist-detail-mode").text((t.name||"Edit Artist")+" "),i(!1),$("#artist-detail").modal()})}function u(){$("#raw-editor").modal()}function c(){$("#reset-dialog").modal()}function f(){$("#import-dialog-file").replaceWith($("#import-dialog-file").clone()),$("#import-dialog").modal()}function m(){Artists.getAll().then(function(t){t.some(function(t){return!!t.tableNumber})?p("Lottery can't be run. Artists are signed in yet."):$("#run-lottery").modal()})}function b(){$("#generate-dialog").modal()}function h(t){var e=$("[data-edit-raw=artist]");t?Artists.get(t).then(function(t){t?(delete t.id,e.val(JSON.stringify(t,null,2))):e.val("")}):e.val("")}function p(t,n){return new Promise(function(r,a){t?($("#alert-title").text(n||"Notice"),$("#alert-body").text(t),$("#alert-dialog").modal({backdrop:"static"}),e(r)):a()})}function y(){Artists.getAll().then(function(t){var e=Filter.checkedOutToday(t).map(function(t){return t.name});e.sort();var n=e.map(function(t){return $("<div/>").text(t)});$("#checked-out-artists-body").html(n),$("#checked-out-artists").modal()})}function v(t,n){return new Promise(function(r,a){t?($("#confirm-title").text(n||"Confirmation Needed"),$("#confirm-body").text(t),$("#confirm-dialog").modal({backdrop:"static"}),e(function(t){t===!0?r(t):a()})):a()})}function g(t,n){return new Promise(function(r,a){t?($("#prompt-dialog input").val(""),$("#prompt-title").text(n||"Input Needed"),$("#prompt-body").text(t),$("#prompt-dialog").modal({backdrop:"static"}),e(function(t){null===t||void 0===t?a():r(t)})):a()})}function w(t,n){return new Promise(function(r,a){t?($("#yes-no-cancel-title").text(n||"Confirmation Needed"),$("#yes-no-cancel-body").text(t),$("#yes-no-cancel-dialog").modal({backdrop:"static"}),e(function(t){t===!0||t===!1?r(t):a()})):a()})}t.Modal={addArtist:o,alert:p,batchSignOut:s,bulkArtistRoom:l,confirm:v,confirmConfirm:n,editArtist:d,editArtistRaw:u,prompt:g,promptConfirm:r,resetDatabase:c,restoreDatabase:f,runLottery:m,seedDatabase:b,setRawArtistId:h,showCheckedOutArtists:y,showYesNoCancel:w};var A=[],k=!1;$(function(){function e(){return Number($("#artist-id").text())}function a(){var t={};return t.id=e(),t.name=$("#artist-name").val(),t.badgeNumber=$("#artist-badge").val(),t.tableNumber=$("#artist-table").val(),t.roomNumber=$("#artist-room").val(),t.phone=$("#artist-phone").val(),t.remarks=$("#artist-remarks").val(),t.lotteryEligible=$("#artist-lottery-eligible").prop("checked"),t.lotteryGuaranteed=$("#artist-lottery-guaranteed").prop("checked"),t.tableNumber&&(t.lotteryOrder=0,t.standbyOrder=0),Artists.set(t)}function i(){var t=[];$("#bulk-artist-room-table input[type=text]").each(function(){var e=$(this),n=e.attr("data-artist-id");n&&t.push({id:n,roomNumber:e.val()})}),Artists.setAll(t)}function s(){$("#artist-detail").modal("toggle")}$("#artist-detail input[type=text]").last().keydown(function(e){13===e.which&&(e.preventDefault(),k?(a(),o(k,!0),t.setTimeout(function(){$("#artist-detail input").first().focus()},10)):$("[data-save=artist]:visible").trigger("click"))}),$("[data-delete=artist]").click(function(){v("Really delete this artist?","Delete Artist Confirmation").then(function(t){t&&(Artists["delete"](e()),s())})}),$("[data-save=artist]").click(function(t){$("#artist-name").val().trim()?(a(),s()):(p("A name is required for this artist.","Save Artist Failed"),t.preventDefault())}),$("[data-save=rooms]").click(function(){i()}),$("[data-standby=artist]").click(function(){var t=function(t){Artists.setStandby(n).then(function(){Artists.getAll().then(function(e){var n=Filter.standbyInOrder(e).length;p("The artist is #"+n+" in standby.","Add "+t.name+" to Standby List").then(function(){s()})})})},n=e();Artists.get(n).then(function(e){var n="Add "+e.name+" to Standby List";e.standbyOrder?v("This artist is already on standby. Performing this action will move them to the bottom of the list.",n).then(function(n){n&&t(e)}):t(e)})}),$("[data-signin=artist]").click(function(){Artists.get(e()).then(function(t){g("Enter a table number.","Sign In for "+t.name).then(function(t){t&&Artists.setSeated(e(),t),s()})})}),$("[data-signout=artist]").click(function(){Artists.get(e()).then(function(t){var n="Signing out "+t.name;t.tableNumber||t.standbyOrder||t.lotteryOrder?w("Would this artist like to be included in tomorrow's lottery?",n).then(function(t){Artists.setSignedOut(e(),!!t),s()}):p("This artist is already signed out.",n).then(s)})}),$("[data-select-raw=artist]").change(function(){var t=$(this).find(":selected"),e=t.attr("value");h(e)}),$("[data-prompt-confirm]").click(function(){r()}),$("[data-confirm-confirm]").click(function(){n(!0)}),$("[data-confirm-deny]").click(function(){n(!1)}),$("[data-confirm-cancel]").click(function(){n(null)}),$("#prompt-dialog input").keydown(function(t){13===t.which&&(t.preventDefault(),$("[data-prompt-confirm]").trigger("click"))})})}(window),function(t){function e(){Artists.getAll().then(function(t){var e=Filter.sorted(t),a=Filter.standbyInOrder(t),i=Filter.seated(t),o=Filter.lotteryInOrder(t),s=Filter.lottery(t),l=Filter.sorted(Filter.checkedOutToday(t));r($(".artist-names"),e,{withSymbols:!0}),r($(".lottery-names"),o,{withOrder:!0}),r($(".standby-names"),a,{withOrder:!0}),r($(".seated-names"),i),r($(".lottery-sorted-names"),s,{disableClick:!0}),r($(".standby-sorted-names"),a,{disableClick:!0}),r($(".seated-sorted-names"),i,{disableClick:!0}),r($(".checkedout-sorted-names"),l,{disableClick:!0}),n($("[data-select-raw=artist]"),e),$(".count-artists").text(t.length),$(".count-lottery").text(o.length),$(".count-standby").text(a.length),$(".count-seated").text(i.length),$(".count-checkedout").text(l.length)})}function n(t,e){var n=$("<div/>");n.append($("<option/>").text("(select one...)")),e.forEach(function(t){n.append($("<option/>").attr("value",t.id).text(t.name))}),t.html(n.html())}function r(t,e,n){n=Object.assign({disableClick:!1,withSymbols:!1,withOrder:!1},n),t.empty(),e.forEach(function(e,r){var i=$("<a/>").addClass("line").text(e.name+" ");if(n.withOrder&&i.prepend(Elements.buildSpan("artist-order").text(""+(r+1)+".")).attr("title","List Order"),e.tableNumber){var o=Elements.buildSpan("artist-seat");o.text("#"+e.tableNumber).attr("title","Table Number"),i.append(o)}if(n.withSymbols){var s=Elements.buildSymbols(e);s.html().length>0&&(s.addClass("faded"),i.append(s))}t.append(i),n.disableClick||i.attr("href","#").click(a(e.id))})}function a(t){return function(){i(t)}}function i(t){Modal.editArtist(t)}t.Names={populate:e}}(window),function(t){function e(t){t.forEach(function(t){t()})}function n(t){a.push(t)}function r(){o||(Database.getTableVersion("artists").then(function(t){t||(t={id:1},Database.open().tableVersions.put(t)),t.artists!==i&&(console.log("Update requested. New version "+t.artists),i=t.artists,e(a)),o=!1}),o=!0)}t.Scheduler={onArtistChange:n};var a=[],i=-1,o=!1;$(function(){t.setInterval(r,500)})}(window),function(t){function e(){var e=$(t).width(),n=0;if(e>960){var r=$(".screen:visible").width();n=(e-r)/2}$(".screen").css("marginLeft",n)}function n(t){$('.screen[id!="'+t+'"]').hide();var n=$(".screen#"+t);if(n.length>0){n.hasClass("hide-nav")&&($("nav").remove(),$(".screen").css("padding-top",0)),n.show(),e();var r=n.find(".content");r.hasClass("scroll-added")||(r.addClass("scroll-added"),r.slimScroll({height:"100%",size:"12px",alwaysVisible:!0}))}}t.Screen={reposition:e,select:n}}(window),function(t){function e(t,e){return Modal.prompt("Confirm by typing '"+t+"' into the box below.",e||"Confirmation").then(function(e){return new Promise(function(n,r){e===t?n(e):r()})})}function n(){return e("close","Close Out Day").then(function(){return Artists.getAll().then(function(t){return Database.transaction(function(){return Dexie.Promise.all(t.map(function(t){return t.tableNumber?Artists.setSignedOut(t.id,!1):t.standbyOrder||t.lotteryOrder?Artists.setSignedOut(t.id,!0):void 0}))})})})}function r(){return Modal.showYesNoCancel("Will you be exporting this CSV for use in Microsoft Excel?","Export CSV").then(function(t){return Artists.getAll().then(function(e){var n="",r=["name","badgeNumber","tableNumber","roomNumber","phone","remarks","seatedLast","seatedDays","standbyDays"];n+=r.join(",")+"\r\n",e.forEach(function(e){var a=[];r.forEach(function(n){var r=e[n];r=r===!1?"N":r===!0?"Y":0===r||r?Array.isArray(r)?r.join("|"):""+r:null,r=null!==r?'"'+r.replace(/"/g,'""')+'"':"",t&&r.length>0&&r.indexOf(",")<0&&(r="="+r),a.push(r)}),n+=a.join(",")+"\r\n"}),FileTransfer.download("Artists.csv",n)})})}function a(t){return Artists.getAll().then(function(e){var n=e.filter(t);n.length>0?Modal.editArtist(n[0].id):Modal.alert("No matching artists were found.","Search Results")})}function i(t,e){var n=""+e;return a(function(e){return e[t]&&""+e[t]===n})}function o(){return Modal.prompt("Enter badge number.","Find Artist by Badge Number").then(function(t){t&&i("badgeNumber",t)})}function s(){return Modal.prompt("Enter table number.","Find Artist by Table Number").then(function(t){t&&i("tableNumber",t)})}function l(){Modal.showCheckedOutArtists()}function d(){Modal.addArtist(!0)}function u(){return e("reset","Wipe Everything").then(Artists.clear)}function c(){return Modal.prompt("How many seats?","Run Lottery").then(function(t){if(t){var e=+t;e>0&&Lottery.run(e)}})}function f(){try{var t=+$("[data-select-raw]").find(":selected").attr("value");if(t){var e=JSON.parse($("[data-edit-raw]").val());e.id=t,Artists.set(e).then(function(){Modal.alert("The artist was saved successfully.")})}}catch(n){Modal.alert("The artist could not be saved:\n"+n.message)}}function m(){return e("generate","Generate Test Data").then(function(){Artists.clear().then(function(){for(var t=[],e=0;e<200;e++)t.push(Generator.getRandomArtist());return Artists.setAll(t)})})}function b(){return Database.backup().then(function(t){var e="backup-"+moment().format("x")+".json";return FileTransfer.download(e,JSON.stringify(t))})}function h(){var t=$("#import-dialog-file")[0].files;return t[0]?FileTransfer.upload(t[0]).then(function(t){var e;try{e=JSON.parse(t)}catch(n){return Promise.reject(n)}return Promise.resolve(e)}).then(Database.restore).then(Modal.alert("The database was restored successfully.","Database Restore"))["catch"](function(t){Modal.alert("There was a problem restoring the database:\n"+t,"Database Restore Failed")}):Promise.reject()}t.SystemActions={batchSignOut:n,databaseBackup:b,databaseRestore:h,exportCsv:r,findArtistByBadge:o,findArtistByTable:s,findCheckedOutArtists:l,newArtistRapidEntry:d,resetDatabase:u,runLottery:c,saveArtistRaw:f,seedDatabase:m}}(window),function(t){function e(){return moment().format("dddd")}t.Time={getTodayString:e}}("undefined"!=typeof window?window:exports),$(function(){function t(){var t=window.location.hash.substring(1);t&&0!==t.length||(t="main"),Screen.select(t)}function e(){$(window).resize(Screen.reposition)}function n(){$("a[data-modal]").each(function(t,e){var n=$(e),r=n.attr("data-modal");n.click(function(){Modal[r]()}),n.attr("href")||n.attr("href","#")})}function r(){$("a[data-screen]").each(function(t,e){var n=$(e),r=n.attr("data-screen");n.attr("href","#"+r).click(function(){Screen.select(r)})})}function a(){$("[data-system-action]").each(function(t,e){var n=$(e),r=n.attr("data-system-action");n.click(function(){SystemActions[r]()}),n.attr("href")||n.attr("href","#")})}n(),r(),t(),e(),a(),Scheduler.onArtistChange(Names.populate),$(function(){function t(){$("body").addClass("modal-open");var t=$(".modal.in").length+1050+1,e=t-1;$(".modal-backdrop").addClass("hidden"),$(".modal.in:last").css("z-index",t),$(".modal-backdrop.in:last").css("z-index",e).removeClass("hidden")}$(document).on("show.bs.modal",".modal",function(){$(this).appendTo($("body"))}).on("shown.bs.modal",".modal.in",function(){t()}).on("hidden.bs.modal",".modal",function(){t(),0===$(".modal.in").length&&$("body").removeClass("modal-open")})})}),$(function(){JoelPurra.PlusAsTab.setOptions({key:13}),$(document).on("shown.bs.modal",".modal",function(){$(this).find("[autofocus]").focus()})});